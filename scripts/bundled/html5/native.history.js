/*
 2010-2011 Benjamin Arthur Lupton <contact@balupton.com>
 @license New BSD License <http://creativecommons.org/licenses/BSD/>
*/
(function(d,m){var g=d.History=d.History||{};if("undefined"!==typeof g.Adapter)throw Error("History.js Adapter has already been loaded...");g.Adapter={handlers:{},_uid:1,uid:function(f){return f._uid||(f._uid=g.Adapter._uid++)},bind:function(f,d,l){var h=g.Adapter.uid(f);g.Adapter.handlers[h]=g.Adapter.handlers[h]||{};g.Adapter.handlers[h][d]=g.Adapter.handlers[h][d]||[];g.Adapter.handlers[h][d].push(l);f["on"+d]=function(f,d){return function(n){g.Adapter.trigger(f,d,n)}}(f,d)},trigger:function(f,
d,l){l=l||{};f=g.Adapter.uid(f);var h,m;g.Adapter.handlers[f]=g.Adapter.handlers[f]||{};g.Adapter.handlers[f][d]=g.Adapter.handlers[f][d]||[];h=0;for(m=g.Adapter.handlers[f][d].length;h<m;++h)g.Adapter.handlers[f][d][h].apply(this,[l])},extractEventData:function(d,g){return g&&g[d]||m},onDomLoad:function(f){var g=d.setTimeout(function(){f()},2E3);d.onload=function(){clearTimeout(g);f()}}};"undefined"!==typeof g.init&&g.init()})(window);/*
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
 2010-2011 Benjamin Arthur Lupton <contact@balupton.com>
 @license New BSD License <http://creativecommons.org/licenses/BSD/>
*/
(function(d,m){var g=d.console||m,f=d.document,n=d.navigator,l=d.sessionStorage||!1,h=d.setTimeout,q=d.clearTimeout,r=d.setInterval,u=d.clearInterval,k=d.JSON,v=d.alert,a=d.History=d.History||{},p=d.history;k.stringify=k.stringify||k.encode;k.parse=k.parse||k.decode;if("undefined"!==typeof a.init)throw Error("History.js Core has already been loaded...");a.init=function(){if("undefined"===typeof a.Adapter)return!1;"undefined"!==typeof a.initCore&&a.initCore();"undefined"!==typeof a.initHtml4&&a.initHtml4();
return!0};a.initCore=function(){if("undefined"!==typeof a.initCore.initialized)return!1;a.initCore.initialized=!0;a.options=a.options||{};a.options.hashChangeInterval=a.options.hashChangeInterval||100;a.options.safariPollInterval=a.options.safariPollInterval||500;a.options.doubleCheckInterval=a.options.doubleCheckInterval||500;a.options.storeInterval=a.options.storeInterval||1E3;a.options.busyDelay=a.options.busyDelay||250;a.options.debug=a.options.debug||!1;a.options.initialTitle=a.options.initialTitle||
f.title;a.intervalList=[];a.clearAllIntervals=function(){var b,c=a.intervalList;if("undefined"!==typeof c&&null!==c){for(b=0;b<c.length;b++)u(c[b]);a.intervalList=null}};a.debug=function(){a.options.debug&&a.log.apply(a,arguments)};a.log=function(){var a=!("undefined"===typeof g||"undefined"===typeof g.log||"undefined"===typeof g.log.apply),c=f.getElementById("log"),e,d,s,h;a?(d=Array.prototype.slice.call(arguments),e=d.shift(),"undefined"!==typeof g.debug?g.debug.apply(g,[e,d]):g.log.apply(g,[e,
d])):e="\n"+arguments[0]+"\n";d=1;for(s=arguments.length;d<s;++d){h=arguments[d];if("object"===typeof h&&"undefined"!==typeof k)try{h=k.stringify(h)}catch(l){}e+="\n"+h+"\n"}c?(c.value+=e+"\n-----\n",c.scrollTop=c.scrollHeight-c.clientHeight):a||v(e);return!0};a.getInternetExplorerMajorVersion=function(){var b=a.getInternetExplorerMajorVersion,c;if("undefined"!==typeof a.getInternetExplorerMajorVersion.cached)c=a.getInternetExplorerMajorVersion.cached;else{c=3;for(var e=f.createElement("div"),d=e.getElementsByTagName("i");(e.innerHTML=
"\x3c!--[if gt IE "+ ++c+"]><i></i><![endif]--\x3e")&&d[0];);c=4<c?c:!1}return b.cached=c};a.isInternetExplorer=function(){return a.isInternetExplorer.cached="undefined"!==typeof a.isInternetExplorer.cached?a.isInternetExplorer.cached:Boolean(a.getInternetExplorerMajorVersion())};a.emulated={pushState:!Boolean(d.history&&d.history.pushState&&d.history.replaceState&&!(/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(n.userAgent)||/AppleWebKit\/5([0-2]|3[0-2])/i.test(n.userAgent))),hashChange:Boolean(!("onhashchange"in
d||"onhashchange"in f)||a.isInternetExplorer()&&8>a.getInternetExplorerMajorVersion())};a.enabled=!a.emulated.pushState;a.bugs={setHash:Boolean(!a.emulated.pushState&&"Apple Computer, Inc."===n.vendor&&/AppleWebKit\/5([0-2]|3[0-3])/.test(n.userAgent)),safariPoll:Boolean(!a.emulated.pushState&&"Apple Computer, Inc."===n.vendor&&/AppleWebKit\/5([0-2]|3[0-3])/.test(n.userAgent)),ieDoubleCheck:Boolean(a.isInternetExplorer()&&8>a.getInternetExplorerMajorVersion()),hashEscape:Boolean(a.isInternetExplorer()&&
7>a.getInternetExplorerMajorVersion())};a.isEmptyObject=function(a){for(var c in a)return!1;return!0};a.cloneObject=function(a){a?(a=k.stringify(a),a=k.parse(a)):a={};return a};a.getRootUrl=function(){var a=f.location.protocol+"//"+(f.location.hostname||f.location.host);f.location.port&&(a+=":"+f.location.port);return a+"/"};a.getBaseHref=function(){var a=f.getElementsByTagName("base"),c=null,c="";1===a.length&&(c=a[0],c=c.href.replace(/[^\/]+$/,""));(c=c.replace(/\/+$/,""))&&(c+="/");return c};a.getBaseUrl=
function(){return a.getBaseHref()||a.getBasePageUrl()||a.getRootUrl()};a.getPageUrl=function(){return((a.getState(!1,!1)||{}).url||f.location.href).replace(/\/+$/,"").replace(/[^\/]+$/,function(a,c,e){return/\./.test(a)?a:a+"/"})};a.getBasePageUrl=function(){return f.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,function(a,c,e){return/[^\/]$/.test(a)?"":a}).replace(/\/+$/,"")+"/"};a.getFullUrl=function(b,c){var e=b,d=b.substring(0,1);c="undefined"===typeof c?!0:c;/[a-z]+\:\/\//.test(b)||(e=
"/"===d?a.getRootUrl()+b.replace(/^\/+/,""):"#"===d?a.getPageUrl().replace(/#.*/,"")+b:"?"===d?a.getPageUrl().replace(/[\?#].*/,"")+b:c?a.getBaseUrl()+b.replace(/^(\.\/)+/,""):a.getBasePageUrl()+b.replace(/^(\.\/)+/,""));return e.replace(/\#$/,"")};a.getShortUrl=function(b){var c=a.getBaseUrl(),e=a.getRootUrl();a.emulated.pushState&&(b=b.replace(c,""));b=b.replace(e,"/");a.isTraditionalAnchor(b)&&(b="./"+b);return b=b.replace(/^(\.\/)+/g,"./").replace(/\#$/,"")};a.store={};a.idToState=a.idToState||
{};a.stateToId=a.stateToId||{};a.urlToId=a.urlToId||{};a.storedStates=a.storedStates||[];a.savedStates=a.savedStates||[];a.normalizeStore=function(){a.store.idToState=a.store.idToState||{};a.store.urlToId=a.store.urlToId||{};a.store.stateToId=a.store.stateToId||{}};a.getState=function(b,c){"undefined"===typeof b&&(b=!0);"undefined"===typeof c&&(c=!0);var e=a.getLastSavedState();!e&&c&&(e=a.createStateObject());b&&(e=a.cloneObject(e),e.url=e.cleanUrl||e.url);return e};a.getIdByState=function(b){var c=
a.extractId(b.url),e;if(!c)if(e=a.getStateString(b),"undefined"!==typeof a.stateToId[e])c=a.stateToId[e];else if("undefined"!==typeof a.store.stateToId[e])c=a.store.stateToId[e];else{for(;!(c=(new Date).getTime()+String(Math.random()).replace(/\D/g,""),"undefined"===typeof a.idToState[c]&&"undefined"===typeof a.store.idToState[c]););a.stateToId[e]=c;a.idToState[c]=b}return c};a.normalizeState=function(b){var c;if(!b||"object"!==typeof b)b={};if("undefined"!==typeof b.normalized)return b;if(!b.data||
"object"!==typeof b.data)b.data={};c={normalized:!0};c.title=b.title||"";c.url=a.getFullUrl(b.url||f.location.href);c.hash=a.getShortUrl(c.url);c.data=a.cloneObject(b.data);c.id=a.getIdByState(c);c.cleanUrl=c.url.replace(/\??\&_suid.*/,"");c.url=c.cleanUrl;b=!a.isEmptyObject(c.data);if(c.title||b)c.hash=a.getShortUrl(c.url).replace(/\??\&_suid.*/,""),/\?/.test(c.hash)||(c.hash+="?"),c.hash+="&_suid="+c.id;c.hashedUrl=a.getFullUrl(c.hash);if((a.emulated.pushState||a.bugs.safariPoll)&&a.hasUrlDuplicate(c))c.url=
c.hashedUrl;return c};a.createStateObject=function(b,c,e){b={data:b,title:c,url:e};return b=a.normalizeState(b)};a.getStateById=function(b){b=String(b);return a.idToState[b]||a.store.idToState[b]||m};a.getStateString=function(b){b={data:a.normalizeState(b).data,title:b.title,url:b.url};return k.stringify(b)};a.getStateId=function(b){return a.normalizeState(b).id};a.getHashByState=function(b){return a.normalizeState(b).hash};a.extractId=function(a){return((a=/(.*)\&_suid=([0-9]+)$/.exec(a))?String(a[2]||
""):"")||!1};a.isTraditionalAnchor=function(a){return!/[\/\?\.]/.test(a)};a.extractState=function(b,c){var e=null,d,f;c=c||!1;(d=a.extractId(b))&&(e=a.getStateById(d));e||(f=a.getFullUrl(b),(d=a.getIdByUrl(f)||!1)&&(e=a.getStateById(d)),!e&&(c&&!a.isTraditionalAnchor(b))&&(e=a.createStateObject(null,null,f)));return e};a.getIdByUrl=function(b){return a.urlToId[b]||a.store.urlToId[b]||m};a.getLastSavedState=function(){return a.savedStates[a.savedStates.length-1]||m};a.getLastStoredState=function(){return a.storedStates[a.storedStates.length-
1]||m};a.hasUrlDuplicate=function(b){var c=!1;return c=(c=a.extractState(b.url))&&c.id!==b.id};a.storeState=function(b){a.urlToId[b.url]=b.id;a.storedStates.push(a.cloneObject(b));return b};a.isLastSavedState=function(b){var c=!1;a.savedStates.length&&(b=b.id,c=a.getLastSavedState(),c=c.id,c=b===c);return c};a.saveState=function(b){if(a.isLastSavedState(b))return!1;a.savedStates.push(a.cloneObject(b));return!0};a.getStateByIndex=function(b){var c=null;return c="undefined"===typeof b?a.savedStates[a.savedStates.length-
1]:0>b?a.savedStates[a.savedStates.length+b]:a.savedStates[b]};a.getHash=function(){return a.unescapeHash(f.location.hash)};a.unescapeHash=function(b){b=a.normalizeHash(b);return b=d.decodeURIComponent(b)};a.normalizeHash=function(a){return a.replace(/[^#]*#/,"").replace(/#.*/,"")};a.setHash=function(b,c){var e,d;if(!1!==c&&a.busy())return a.pushQueue({scope:a,callback:a.setHash,args:arguments,queue:c}),!1;e=a.escapeHash(b);a.busy(!0);(d=a.extractState(b,!0))&&!a.emulated.pushState?a.pushState(d.data,
d.title,d.url,!1):f.location.hash!==e&&(a.bugs.setHash?(d=a.getPageUrl(),a.pushState(null,null,d+"#"+e,!1)):f.location.hash=e);return a};a.escapeHash=function(b){b=a.normalizeHash(b);b=d.encodeURIComponent(b);a.bugs.hashEscape||(b=b.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?"));return b};a.getHashByUrl=function(b){b=String(b).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return b=a.unescapeHash(b)};a.setTitle=function(b){var c=b.title,e;c||(e=a.getStateByIndex(0))&&
e.url===b.url&&(c=e.title||a.options.initialTitle);try{f.getElementsByTagName("title")[0].innerHTML=c.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(d){}f.title=c;return a};a.queues=[];a.busy=function(b){"undefined"!==typeof b?a.busy.flag=b:"undefined"===typeof a.busy.flag&&(a.busy.flag=!1);if(!a.busy.flag){q(a.busy.timeout);var c=function(){var b,d;if(!a.busy.flag)for(b=a.queues.length-1;0<=b;--b)d=a.queues[b],0!==d.length&&(d=d.shift(),a.fireQueueItem(d),a.busy.timeout=h(c,
a.options.busyDelay))};a.busy.timeout=h(c,a.options.busyDelay)}return a.busy.flag};a.busy.flag=!1;a.fireQueueItem=function(b){return b.callback.apply(b.scope||a,b.args||[])};a.pushQueue=function(b){a.queues[b.queue||0]=a.queues[b.queue||0]||[];a.queues[b.queue||0].push(b);return a};a.queue=function(b,c){"function"===typeof b&&(b={callback:b});"undefined"!==typeof c&&(b.queue=c);a.busy()?a.pushQueue(b):a.fireQueueItem(b);return a};a.clearQueue=function(){a.busy.flag=!1;a.queues=[];return a};a.stateChanged=
!1;a.doubleChecker=!1;a.doubleCheckComplete=function(){a.stateChanged=!0;a.doubleCheckClear();return a};a.doubleCheckClear=function(){a.doubleChecker&&(q(a.doubleChecker),a.doubleChecker=!1);return a};a.doubleCheck=function(b){a.stateChanged=!1;a.doubleCheckClear();a.bugs.ieDoubleCheck&&(a.doubleChecker=h(function(){a.doubleCheckClear();a.stateChanged||b();return!0},a.options.doubleCheckInterval));return a};a.safariStatePoll=function(){var b=a.extractState(f.location.href);if(!a.isLastSavedState(b))return b||
a.createStateObject(),a.Adapter.trigger(d,"popstate"),a};a.back=function(b){if(!1!==b&&a.busy())return a.pushQueue({scope:a,callback:a.back,args:arguments,queue:b}),!1;a.busy(!0);a.doubleCheck(function(){a.back(!1)});p.go(-1);return!0};a.forward=function(b){if(!1!==b&&a.busy())return a.pushQueue({scope:a,callback:a.forward,args:arguments,queue:b}),!1;a.busy(!0);a.doubleCheck(function(){a.forward(!1)});p.go(1);return!0};a.go=function(b,c){var d;if(0<b)for(d=1;d<=b;++d)a.forward(c);else if(0>b)for(d=
-1;d>=b;--d)a.back(c);else throw Error("History.go: History.go requires a positive or negative integer passed.");return a};if(a.emulated.pushState){var t=function(){};a.pushState=a.pushState||t;a.replaceState=a.replaceState||t}else a.onPopState=function(b,c){var e=!1,e=!1;a.doubleCheckComplete();if(e=a.getHash())return(e=a.extractState(e||f.location.href,!0))?a.replaceState(e.data,e.title,e.url,!1):(a.Adapter.trigger(d,"anchorchange"),a.busy(!1)),a.expectedStateId=!1;(e=(e=a.Adapter.extractEventData("state",
b,c)||!1)?a.getStateById(e):a.expectedStateId?a.getStateById(a.expectedStateId):a.extractState(f.location.href))||(e=a.createStateObject(null,null,f.location.href));a.expectedStateId=!1;if(a.isLastSavedState(e))return a.busy(!1),!1;a.storeState(e);a.saveState(e);a.setTitle(e);a.Adapter.trigger(d,"statechange");a.busy(!1);return!0},a.Adapter.bind(d,"popstate",a.onPopState),a.pushState=function(b,c,e,f){if(a.getHashByUrl(e)&&a.emulated.pushState)throw Error("History.js does not support states with fragment-identifiers (hashes/anchors).");
if(!1!==f&&a.busy())return a.pushQueue({scope:a,callback:a.pushState,args:arguments,queue:f}),!1;a.busy(!0);var g=a.createStateObject(b,c,e);a.isLastSavedState(g)?a.busy(!1):(a.storeState(g),a.expectedStateId=g.id,p.pushState(g.id,g.title,g.url),a.Adapter.trigger(d,"popstate"));return!0},a.replaceState=function(b,c,e,f){if(a.getHashByUrl(e)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(!1!==f&&a.busy())return a.pushQueue({scope:a,
callback:a.replaceState,args:arguments,queue:f}),!1;a.busy(!0);var g=a.createStateObject(b,c,e);a.isLastSavedState(g)?a.busy(!1):(a.storeState(g),a.expectedStateId=g.id,p.replaceState(g.id,g.title,g.url),a.Adapter.trigger(d,"popstate"));return!0};if(l)try{a.store=k.parse(l.getItem("History.store"))||{}}catch(w){a.store={}}else a.store={};a.normalizeStore();a.Adapter.bind(d,"beforeunload",a.clearAllIntervals);a.Adapter.bind(d,"unload",a.clearAllIntervals);a.saveState(a.storeState(a.extractState(f.location.href,
!0)));l&&(a.onUnload=function(){var b,c;try{b=k.parse(l.getItem("History.store"))||{}}catch(d){b={}}b.idToState=b.idToState||{};b.urlToId=b.urlToId||{};b.stateToId=b.stateToId||{};for(c in a.idToState)a.idToState.hasOwnProperty(c)&&(b.idToState[c]=a.idToState[c]);for(c in a.urlToId)a.urlToId.hasOwnProperty(c)&&(b.urlToId[c]=a.urlToId[c]);for(c in a.stateToId)a.stateToId.hasOwnProperty(c)&&(b.stateToId[c]=a.stateToId[c]);a.store=b;a.normalizeStore();l.setItem("History.store",k.stringify(b))},a.intervalList.push(r(a.onUnload,
a.options.storeInterval)),a.Adapter.bind(d,"beforeunload",a.onUnload),a.Adapter.bind(d,"unload",a.onUnload));if(!a.emulated.pushState&&(a.bugs.safariPoll&&a.intervalList.push(r(a.safariStatePoll,a.options.safariPollInterval)),"Apple Computer, Inc."===n.vendor||"Mozilla"===(n.appCodeName||"")))if(a.Adapter.bind(d,"hashchange",function(){a.Adapter.trigger(d,"popstate")}),a.getHash())a.Adapter.onDomLoad(function(){a.Adapter.trigger(d,"hashchange")})};a.init()})(window);
